<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers Map Application</title>
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.1.0/ol.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            background: #f4f6fa;
        }
        #map {
            width: 100vw;
            height: 100vh;
        }
        #basemap-switcher {
            position: absolute;
            right: 28px;
            bottom: 28px;
            z-index: 1200;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.10);
            border: 1px solid #e3e7ef;
            padding: 8px 14px 8px 14px;
            font-size: 1rem;
            color: #2d3a4a;
        }
        #basemap-switcher select {
            font-size: 1rem;
            border-radius: 7px;
            border: 1px solid #d1d7e6;
            padding: 5px 10px;
            background: #f8fafc;
            outline: none;
        }
        .info-panel {
            position: absolute;
            top: 24px;
            left: 24px;
            background: #fff;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.10), 0 1.5px 4px 0 rgba(0,0,0,0.08);
            padding: 24px 20px 18px 20px;
            border-radius: 16px;
            z-index: 1000;
            max-width: 370px;
            min-width: 270px;
            border: 1px solid #e3e7ef;
        }
        .info-panel h3 {
            margin-top: 0;
            font-size: 1.3rem;
            color: #2d3a4a;
            letter-spacing: 0.5px;
        }
        .info-panel h4 {
            margin-bottom: 6px;
            margin-top: 18px;
            font-size: 1.08rem;
            color: #3b4a5a;
        }
        .info-panel input, .info-panel select {
            width: 100%;
            margin-bottom: 8px;
            padding: 8px 10px;
            border: 1px solid #d1d7e6;
            border-radius: 7px;
            font-size: 1rem;
            background: #f8fafc;
            transition: border 0.2s;
            outline: none;
        }
        .info-panel input:focus, .info-panel select:focus {
            border: 1.5px solid #4a90e2;
            background: #fff;
        }
        .info-panel button {
            width: 100%;
            margin-bottom: 8px;
            padding: 9px 0;
            background: linear-gradient(90deg, #4a90e2 60%, #357ab8 100%);
            color: #fff;
            border: none;
            border-radius: 7px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 1.5px 4px 0 rgba(0,0,0,0.07);
            transition: background 0.2s, box-shadow 0.2s;
        }
        .info-panel button:hover {
            background: linear-gradient(90deg, #357ab8 60%, #4a90e2 100%);
            box-shadow: 0 4px 12px 0 rgba(74,144,226,0.10);
        }
        .info-panel hr {
            border: none;
            border-top: 1px solid #e3e7ef;
            margin: 18px 0 14px 0;
        }
        #drop-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 24px 32px;
            background: rgba(44, 62, 80, 0.85);
            color: #fff;
            border-radius: 16px;
            text-align: center;
            z-index: 999;
            pointer-events: none;
            opacity: 0;
            font-size: 1.1rem;
            letter-spacing: 0.2px;
            transition: opacity 0.3s;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.13);
        }
        body.dragover #drop-zone {
            opacity: 1;
        }
        #layer-list-sidebar {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 300px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.10), 0 1.5px 4px 0 rgba(0,0,0,0.08);
            border: 1px solid #e3e7ef;
            z-index: 1001;
            padding: 18px 16px 12px 16px;
            min-height: 120px;
            max-height: 70vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #layer-list-sidebar h4 {
            margin: 0 0 10px 0;
            font-size: 1.08rem;
            color: #3b4a5a;
        }
        #layer-list {
            list-style:none;
            padding:0;
            margin:6px 0 0 0;
        }
        #layer-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border-radius: 7px;
            margin-bottom: 7px;
            padding: 7px 10px 7px 10px;
            box-shadow: 0 1.5px 4px 0 rgba(0,0,0,0.04);
            font-size: 0.98rem;
        }
        #layer-list li b {
            flex: 1;
            color: #2d3a4a;
            font-weight: 500;
            font-size: 1.01rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #layer-list li button {
            width: auto;
            min-width: 32px;
            margin: 0 0 0 6px;
            padding: 5px 0;
            border-radius: 5px;
            background: #f4f6fa;
            color: #4a90e2;
            border: 1px solid #e3e7ef;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: none;
            transition: background 0.2s, color 0.2s;
        }
        #layer-list li button:hover {
            background: #eaf2fb;
            color: #357ab8;
        }
        @media (max-width: 600px) {
            .info-panel {
                left: 0;
                right: 0;
                top: 0;
                max-width: 100vw;
                min-width: 0;
                border-radius: 0 0 16px 16px;
                padding: 12px 6vw 10px 6vw;
            }
        }
        #get-layers-btn:disabled {
          background: #e0e0e0 !important;
          color: #888 !important;
          border: 1px solid #ccc !important;
          opacity: 0.5 !important;
          cursor: not-allowed !important;
        }
        #loader {
            display:none;
            position:fixed;
            top:0;
            left:0;
            width:100vw;
            height:100vh;
            background:rgba(255,255,255,0.45);
            z-index:2000;
            align-items:center;
            justify-content:center;
        }
        #loader div {
            background:#fff;
            padding:28px 36px;
            border-radius:16px;
            box-shadow:0 4px 24px 0 rgba(0,0,0,0.13);
            display:flex;
            flex-direction:column;
            align-items:center;
        }
        @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    </style>
</head>
<body>
    <!-- Map container -->
    <div id="map"></div>

    <!-- Drag-and-drop info area -->
    <div id="drop-zone">Drag and drop a supported file here (.geojson, .kml, .gpx, .gml, .igc)</div>

    <!-- Loader -->
    <div id="loader">
        <div>
            <div style="border:6px solid #e3e7ef;border-top:6px solid #4a90e2;border-radius:50%;width:38px;height:38px;animation:spin 1s linear infinite;"></div>
            <div style="margin-top:14px;font-size:1.08rem;color:#357ab8;">Loading...</div>
        </div>
    </div>

    <!-- Service add and info panel -->
    <div class="info-panel">
        <h3>OpenLayers Map Viewer</h3>
        <p>
            Drag & drop files (.geojson, .kml, .gpx) or add a map service below.
        </p>
        <hr>
        <h4>Add Map Service</h4>
        <label for="service-type">Service Type:</label>
        <select id="service-type">
            <option value="wms">WMS</option>
            <option value="wfs">WFS</option>
            <option value="mapserver">ArcGIS MapServer</option>
            <option value="featureserver">ArcGIS FeatureServer</option>
        </select>
        
        <label for="service-url" style="margin-top:8px; display:block;">Service URL:</label>
        <input type="text" id="service-url" placeholder="Enter service URL...">
        
        <button id="get-layers-btn" style="margin-top:8px;">Get Layers</button>
        
        <select id="service-layers-select" style="width:100%;margin-top:5px;display:none;"></select>
        
        <button id="add-layer-btn" style="display:none;">Add Layer</button>
    </div>

    <!-- Layer list -->
    <div id="layer-list-sidebar">
        <h4>Layers</h4>
        <ul id="layer-list"></ul>
    </div>

    <!-- Basemap switcher -->
    <div id="basemap-switcher">
        <label for="basemap-select" style="font-size:0.98rem;">Basemap:</label>
        <select id="basemap-select">
            <option value="osm">OpenStreetMap</option>
            <option value="google_street">Google Streets</option>
            <option value="google_sat">Google Satellite</option>
            <option value="google_hybrid">Google Hybrid</option>
        </select>
    </div>

    <!-- OpenLayers JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.1.0/dist/ol.js"></script>
    
    <script>
        // --- DEMO SERVICE URLS ---
        const DEMO_SERVICES = {
            wms: 'https://view.eumetsat.int/geoserver/ows?service=WMS',
            wfs: 'https://view.eumetsat.int/geoserver/ows?service=WFS',
            mapserver: 'https://sampleserver6.arcgisonline.com/arcgis/rest/services/OilSandsProjectBoundaries/MapServer',
            featureserver: 'https://sampleserver6.arcgisonline.com/arcgis/rest/services/OilSandsProjectBoundaries/FeatureServer'
        };

        // --- MAP INITIALIZATION ---
        const basemaps = {
            osm: new ol.layer.Tile({ source: new ol.source.OSM() }),
            google_street: new ol.layer.Tile({ source: new ol.source.XYZ({ url: 'https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}' }) }),
            google_sat: new ol.layer.Tile({ source: new ol.source.XYZ({ url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}' }) }),
            google_hybrid: new ol.layer.Tile({ source: new ol.source.XYZ({ url: 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}' }) })
        };

        const map = new ol.Map({
            target: 'map',
            layers: [basemaps.osm],
            view: new ol.View({
                center: ol.proj.fromLonLat([35, 39]),
                zoom: 6
            })
        });

        // --- UI ELEMENT REFERENCES ---
        const loader = document.getElementById('loader');
        const serviceTypeSelect = document.getElementById('service-type');
        const serviceUrlInput = document.getElementById('service-url');
        const getLayersBtn = document.getElementById('get-layers-btn');
        const serviceLayersSelect = document.getElementById('service-layers-select');
        const addLayerBtn = document.getElementById('add-layer-btn');
        const basemapSelect = document.getElementById('basemap-select');

        // --- LAYER MANAGEMENT ---
        const layerManager = [];

        function updateLayerList() {
            const ul = document.getElementById('layer-list');
            ul.innerHTML = '';
            layerManager.forEach((item, idx) => {
                const li = document.createElement('li');
                let name = item.name || 'Unnamed Layer';
                li.innerHTML = `<b>${name}</b>` +
                    `<button onclick="zoomToLayer(${idx})" title="Zoom to Layer">🔍</button>` +
                    `<button onclick="toggleLayer(${idx})" title="Toggle Visibility">${item.layer.getVisible() ? '👁️' : '🚫'}</button>` +
                    `<button onclick="removeLayer(${idx})" title="Remove">❌</button>`;
                ul.appendChild(li);
            });
        }

        async function zoomToLayer(idx) {
            loader.style.display = 'flex';
            try {
                const item = layerManager[idx];
                if (!item) return;

                const view = map.getView();
                let extent = null;

                if (item.layer instanceof ol.layer.Vector) {
                    extent = item.layer.getSource().getExtent();
                    if (extent && !ol.extent.isEmpty(extent)) {
                        view.fit(extent, { maxZoom: 16, duration: 500, padding: [50, 50, 50, 50] });
                        return;
                    }
                }

                if (item.type === 'WMS' && item.wmsUrl && item.layerName) {
                    const getCapUrl = item.wmsUrl + (item.wmsUrl.includes('?') ? '&' : '?') + 'service=WMS&request=GetCapabilities';
                    const resp = await fetch(getCapUrl);
                    if (resp.ok) {
                        const text = await resp.text();
                        const capabilities = new ol.format.WMSCapabilities().read(text);
                        const findLayer = (layers, name) => {
                            for (const lyr of layers) {
                                if (lyr.Name === name) return lyr;
                                if (lyr.Layer) {
                                    const found = findLayer(lyr.Layer, name);
                                    if (found) return found;
                                }
                            }
                            return null;
                        };
                        let targetLayer = findLayer(capabilities.Capability.Layer.Layer, item.layerName);
                        if (targetLayer && targetLayer.EX_GeographicBoundingBox) {
                             extent = ol.proj.transformExtent(targetLayer.EX_GeographicBoundingBox, 'EPSG:4326', view.getProjection());
                        }
                    }
                }

                if ((item.type === 'ArcGIS MapServer' || item.type === 'ArcGIS FeatureServer') && item.serviceUrl) {
                    const reqUrl = item.layerId ? `${item.serviceUrl}/${item.layerId}?f=json` : `${item.serviceUrl}?f=json`;
                    const resp = await fetch(reqUrl);
                    if (resp.ok) {
                        const data = await resp.json();
                        const serviceExtent = data.extent || data.fullExtent;
                        if (serviceExtent) {
                            const srid = serviceExtent.spatialReference.wkid || 4326;
                            extent = ol.proj.transformExtent([serviceExtent.xmin, serviceExtent.ymin, serviceExtent.xmax, serviceExtent.ymax], `EPSG:${srid}`, view.getProjection());
                        }
                    }
                }

                if (extent && !ol.extent.isEmpty(extent)) {
                    view.fit(extent, { maxZoom: 16, duration: 500, padding: [50, 50, 50, 50] });
                } else {
                    alert('Could not determine layer extent.');
                }
            } catch (e) {
                console.error("Zoom to layer failed:", e);
                alert('An error occurred while trying to zoom to the layer.');
            } finally {
                loader.style.display = 'none';
            }
        }

        function toggleLayer(idx) {
            const item = layerManager[idx];
            if (item) {
                const isVisible = item.layer.getVisible();
                item.layer.setVisible(!isVisible);
                updateLayerList();
            }
        }

        function removeLayer(idx) {
            const item = layerManager.splice(idx, 1)[0];
            if (item) {
                map.removeLayer(item.layer);
                updateLayerList();
            }
        }

        // Expose functions to global scope for onclick attributes
        window.zoomToLayer = zoomToLayer;
        window.toggleLayer = toggleLayer;
        window.removeLayer = removeLayer;
        
        // --- EVENT LISTENERS ---
        basemapSelect.addEventListener('change', (e) => {
            const selectedKey = e.target.value;
            // Remove all basemaps first
             Object.values(basemaps).forEach(layer => map.removeLayer(layer));
             // Add the new one at the bottom
            map.getLayers().insertAt(0, basemaps[selectedKey]);
        });

        serviceTypeSelect.addEventListener('change', () => {
            const type = serviceTypeSelect.value;
            serviceUrlInput.value = DEMO_SERVICES[type] || '';
            updateGetLayersBtnState();
        });

        serviceUrlInput.addEventListener('input', updateGetLayersBtnState);

        function updateGetLayersBtnState() {
            getLayersBtn.disabled = !serviceUrlInput.value.trim();
        }
        
        getLayersBtn.onclick = async () => {
            const type = serviceTypeSelect.value;
            const url = serviceUrlInput.value.trim();
            serviceLayersSelect.innerHTML = '';
            serviceLayersSelect.style.display = 'none';
            addLayerBtn.style.display = 'none';

            if (!url) {
                alert('Please enter a service URL.');
                return;
            }

            loader.style.display = 'flex';
            try {
                let layers = [];
                if (type === 'wms') {
                    layers = await fetchWmsLayers(url);
                } else if (type === 'wfs') {
                    layers = await fetchWfsLayers(url);
                } else if (type === 'mapserver' || type === 'featureserver') {
                    layers = await fetchArcGisLayers(url);
                }

                if (layers.length > 0) {
                    layers.forEach(layer => {
                        const opt = document.createElement('option');
                        opt.value = layer.id;
                        opt.textContent = layer.name;
                        serviceLayersSelect.appendChild(opt);
                    });
                    serviceLayersSelect.style.display = 'block';
                    addLayerBtn.style.display = 'block';
                } else {
                    alert('No layers found at this service URL.');
                }
            } catch (e) {
                alert('Error fetching layers: ' + e.message);
                console.error(e);
            } finally {
                loader.style.display = 'none';
            }
        };

        addLayerBtn.onclick = () => {
            const type = serviceTypeSelect.value;
            const url = serviceUrlInput.value.trim();
            const selectedOption = serviceLayersSelect.options[serviceLayersSelect.selectedIndex];
            const layerId = selectedOption.value;
            const layerName = selectedOption.textContent;

            loader.style.display = 'flex';
            try {
                let newLayer;
                let layerInfo = { name: layerName, type: '', layer: null };

                if (type === 'wms') {
                    newLayer = new ol.layer.Image({
                        source: new ol.source.ImageWMS({ url, params: {'LAYERS': layerId}, serverType: 'geoserver' })
                    });
                    layerInfo.type = 'WMS';
                    layerInfo.wmsUrl = url;
                    layerInfo.layerName = layerId;
                } else if (type === 'wfs') {
                     const wfsUrl = `${url.split('?')[0]}?service=WFS&version=1.1.0&request=GetFeature&typename=${encodeURIComponent(layerId)}&outputFormat=application/json&srsname=${map.getView().getProjection().getCode()}`;
                    newLayer = new ol.layer.Vector({
                        source: new ol.source.Vector({ format: new ol.format.GeoJSON(), url: wfsUrl }),
                        style: new ol.style.Style({ stroke: new ol.style.Stroke({ color: 'blue', width: 2 }) })
                    });
                     layerInfo.type = 'WFS';
                } else if (type === 'mapserver') {
                    newLayer = new ol.layer.Tile({
                        source: new ol.source.TileArcGISRest({ url, params: {'LAYERS': 'show:' + layerId} })
                    });
                    layerInfo.type = 'ArcGIS MapServer';
                    layerInfo.serviceUrl = url;
                    layerInfo.layerId = layerId;
                } else if (type === 'featureserver') {
                    const featureUrl = `${url.replace(/\/$/, '')}/${layerId}/query?where=1=1&outFields=*&f=geojson`;
                     newLayer = new ol.layer.Vector({
                        source: new ol.source.Vector({ format: new ol.format.GeoJSON(), url: featureUrl }),
                        style: new ol.style.Style({ stroke: new ol.style.Stroke({ color: 'green', width: 2 }) })
                    });
                    layerInfo.type = 'ArcGIS FeatureServer';
                    layerInfo.serviceUrl = url;
                    layerInfo.layerId = layerId;
                }

                if (newLayer) {
                    layerInfo.layer = newLayer;
                    map.addLayer(newLayer);
                    layerManager.push(layerInfo);
                    updateLayerList();
                    alert(`Layer "${layerName}" added.`);
                }
            } catch (e) {
                alert('Failed to add layer: ' + e.message);
            } finally {
                loader.style.display = 'none';
            }
        };

        // --- SERVICE FETCHING FUNCTIONS ---
        async function fetchWmsLayers(url) {
            const getCapUrl = url + (url.includes('?') ? '&' : '?') + 'service=WMS&request=GetCapabilities';
            const resp = await fetch(getCapUrl);
            if (!resp.ok) throw new Error('WMS GetCapabilities request failed.');
            const text = await resp.text();
            const caps = new ol.format.WMSCapabilities().read(text);
            return caps.Capability.Layer.Layer.map(l => ({ id: l.Name, name: l.Title }));
        }

        async function fetchWfsLayers(url) {
            const getCapUrl = url + (url.includes('?') ? '&' : '?') + 'service=WFS&request=GetCapabilities';
            const resp = await fetch(getCapUrl);
            if (!resp.ok) throw new Error('WFS GetCapabilities request failed.');
            const text = await resp.text();
            const xml = new DOMParser().parseFromString(text, 'text/xml');
            const featureTypes = Array.from(xml.getElementsByTagName('FeatureType'));
            return featureTypes.map(ft => ({
                id: ft.getElementsByTagName('Name')[0].textContent,
                name: ft.getElementsByTagName('Title')[0]?.textContent || ft.getElementsByTagName('Name')[0].textContent
            }));
        }

        async function fetchArcGisLayers(url) {
            const resp = await fetch(url + '?f=json');
            if (!resp.ok) throw new Error('ArcGIS service request failed.');
            const data = await resp.json();
            if (!data.layers) throw new Error('No layers found in service response.');
            return data.layers.map(l => ({ id: l.id, name: l.name }));
        }

        // --- INITIALIZATION ---
        serviceUrlInput.value = DEMO_SERVICES[serviceTypeSelect.value];
        updateGetLayersBtnState();
        updateLayerList();

    </script>
</body>
</html>